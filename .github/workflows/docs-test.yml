name: Documentation Build Test

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-test.yml'

jobs:
  test-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: false
    
    - name: Verify Jekyll configuration
      run: |
        cd docs
        if [ ! -f "_config.yml" ]; then
          echo "Error: _config.yml not found!"
          exit 1
        fi
        echo "Jekyll configuration found ✓"
    
    - name: Update Bundler
      run: |
        gem install bundler:2.7.2
        
    - name: Install dependencies
      run: |
        cd docs
        bundle install
    
    - name: Build documentation
      run: |
        cd docs
        bundle exec jekyll build --verbose --trace
      
    - name: Verify build output
      run: |
        cd docs
        if [ ! -d "_site" ]; then
          echo "Error: _site directory not created!"
          exit 1
        fi
        if [ ! -f "_site/index.html" ]; then
          echo "Error: index.html not generated!"
          exit 1
        fi
        echo "Documentation build successful ✓"
    
    - name: Check for broken internal links
      run: |
        cd docs/_site
        echo "Checking for broken internal links..."
        BROKEN_LINKS=0
        
        # Find all HTML files and check internal links
        for file in $(find . -name "*.html"); do
          # Extract href links and check if target files exist
          grep -o 'href="[^"]*"' "$file" | sed 's/href="//;s/"//' | while read link; do
            # Skip external links, anchors, and mailto
            if [[ "$link" =~ ^http ]] || [[ "$link" =~ ^mailto ]] || [[ "$link" =~ ^# ]]; then
              continue
            fi
            
            # Convert link to file path
            target="${link#/}"
            if [ -n "$target" ] && [ ! -e "$target" ] && [ ! -e "${target}.html" ] && [ ! -d "$target" ]; then
              echo "Broken link in $file: $link"
              BROKEN_LINKS=$((BROKEN_LINKS + 1))
            fi
          done
        done
        
        echo "Link check complete. Found $BROKEN_LINKS potential broken links."
    
    - name: List generated files
      run: |
        echo "Generated documentation structure:"
        tree -L 2 docs/_site/ || ls -laR docs/_site/
        
    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation-site
        path: docs/_site/
        retention-days: 7
